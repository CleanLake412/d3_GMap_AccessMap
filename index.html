<!doctype html>
<html lang="ja">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" type="image/png" href="favicon.png"/>
    <title>Access map sample</title>

    <style>
    </style>
</head>
<body>
    <svg id="access-map"></svg>

    <script src="vendor/jquery/jquery.v3.5.1.min.js"></script>
    <script src="vendor/d3/d3.v6.min.js"></script>

    <script>
        let stations = {}, // {id, name, headsign, line_name, line}
            links = []; // source, target, travel_mode, distance, duration, num_stops

        $(document).ready(function(){

            d3.json('data/routes.json').then(function(routes) {
                console.log(routes);
                console.log(analyzeRoutes(routes.routes));
            });

        });

        function renderAccessMap(data, codeLabels, codeValues, matrix) {

            const d = 640;
            const svg = d3.select("#access-map")
                .attr("cursor", "default")
                .attr("width", d*1.5)
                .attr("height", d);

        }

        function analyzeRoutes(routes) {
            // 出発地、目的地の名前
            let departure = routes[0].legs[0].start_address;
            let arrival = routes[0].legs[0].end_address;

            // ルート基本情報
            let routesInfo = [], route, i;

            // 駅、リンク
            stations['departure'] = {
                id: "departure",
                name: departure
            };
            stations['arrival'] = {
                id: "arrival",
                name: arrival
            };

            let prevStationId, newStationId;
            let linkInfo = null, changeInfo = null;
            for (i in routes) {
                route = routes[i];
                linkInfo = null;
                changeInfo = null;

                // 距離、所要時間
                routesInfo[i] = {};
                routesInfo[i].distance = route.legs[0].distance.value;
                routesInfo[i].duration = route.legs[0].duration.value;

                // Steps分析
                prevStationId = "departure";

                let step, j, stepCount = route.legs[0].steps.length;
                for (j in route.legs[0].steps) {
                    step = route.legs[0].steps[j];
                    if (prevStationId !== "departure" &&
                        (step.distance.value < 100/*meters*/ || step.duration.value < 100/*seconds*/) &&
                        j < stepCount - 1 // 最後のステップではない
                    ) {
                        // 1分以内の経路はスキップ、乗り換えたと判断する
                        changeInfo = {
                            ...changeInfo,
                            distance: step.distance.value,
                            duration: step.duration.value,
                            //lineA: {},
                            //stationA: '',
                            lineB: {},
                            stationB: ''
                        };
                        continue;
                    }

                    if (step.travel_mode === "WALKING") {
                        if (j*1 === stepCount - 1) { // 最後のステップ

                            // 到着地を追加
                            addNewStation(newStationId, {
                                name: "arrival"
                            }, {
                                source: newStationId,
                                target: "arrival",
                                travel_mode: "WALKING",
                                distance: step.distance.value,
                                duration: step.duration.value
                            });

                            break;
                        }

                        // 駅まで徒歩で行く場合、駅情報は取得できないため連結情報のみ取得する
                        linkInfo = {
                            source: prevStationId,
                            travel_mode: "WALKING",
                            distance: step.distance.value,
                            duration: step.duration.value
                        };
                    } else if (step.travel_mode === "TRANSIT") {
                        // 出発駅を追加
                        if (linkInfo === null) {
                            console.error("empty linkInfo");
                            break;
                        }
                        if (changeInfo !== null) {
                            changeInfo.lineB = step.transit.line;
                            changeInfo.stationB = step.transit.departure_stop.name;
                            linkInfo.change = changeInfo;
                        }
                        newStationId = addNewStation(prevStationId, {
                            name: step.transit.departure_stop.name,
                            headsign: '',
                            line_name: step.transit.line.name,
                            line: step.transit.line
                        }, linkInfo);
                        prevStationId = newStationId;

                        // 到着駅
                        linkInfo = {
                            source: prevStationId,
                            travel_mode: "TRANSIT",
                            distance: step.distance.value,
                            duration: step.duration.value,
                            num_stops: step.transit.num_stops
                        };
                        if (j*1 === stepCount - 2) { // 最後の公共交通
                            // 最後の駅を追加
                            newStationId = addNewStation(prevStationId, {
                                name: step.transit.arrival_stop.name,
                                headsign: step.transit.headsign,
                                line_name: step.transit.line.name,
                                line: step.transit.line
                            }, linkInfo);
                            prevStationId = newStationId;
                        } else {
                            // 乗り換え情報
                            changeInfo = {
                                headsign: step.transit.headsign,
                                lineA: step.transit.line,
                                stationA: step.transit.arrival_stop.name
                            };
                        }
                    }
                } // end of for steps of route
            } // end of for routes

            return {
                departure, arrival,
                routes: routesInfo,
                spots: stations, links
            };
        }

        /**
         * 新しい駅を追加する
         *
         * @param prevStation string
         * @param newStationInfo object
         * @param linkInfo object
         * @return string 新規駅のID
         */
        function addNewStation(prevStation, newStationInfo, linkInfo) {
            let newStationId = newStationInfo.name;
            if (!(newStationId in stations)) {
                newStationInfo.id = newStationId;
                stations[newStationId] = newStationInfo;
            }

            linkInfo.source = prevStation;
            linkInfo.target = newStationId;
            links.push(linkInfo);

            return newStationId;
        }

    </script>
</body>
</html>